<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <title>MConf: remesh.cpp</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <meta name="author" content="Yuriy Turkin">
  <meta name="keywords" content="stellarator, w7x, W7-X, W7-X software">
  <meta name="description" content="W7-X Software">
  <link href="myCss.css" rel="stylesheet" type="text/css">
  <link href="tabs.css" rel="stylesheet" type="text/css" >
</head>
<body>
  <div class="centerAll" id="TopOfPage">
    <div class="bodyForAll">
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>remesh.cpp</h1>This is an example of how to use the CStconfig::writeasciiReduced() method. The program truncates Fourier spectrum to given accuracy and transforms everything on new s-mesh that is equidistant on r<sub>eff</sub>. The error distribution is printed.<p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;time.h&gt;</span>

<span class="preprocessor">#include "../include/CStconfig.h"</span>

<span class="keywordtype">void</span> SeedRandom(<span class="keywordtype">int</span> sw);     <span class="comment">// Set seed value for random number generator</span>
<span class="keywordtype">double</span> Random(<span class="keywordtype">void</span>);         <span class="comment">// Returns uniformly distributed random number between 0 and 1</span>

<span class="keyword">template</span> &lt;<span class="keyword">class</span> T&gt; <span class="keyword">static</span> <span class="keyword">inline</span> T <a name="a0"></a><a class="code" href="cpp2for_8cpp.html#42af2ca7ecd9ddfa9c9a609023ee50bb">mmax</a> (T x, T y) { <span class="keywordflow">return</span> (x&gt;y)?x:y; }

<span class="comment">//*********************************************************************</span>
<span class="comment">// This program truncates Fourier spectrum to given accuracy and transforms</span>
<span class="comment">//  everything on new mesh that is equidistant on reff.</span>
<span class="comment">//</span>
<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])
{
  <span class="keyword">const</span> <span class="keywordtype">double</span> <a name="a1"></a><a class="code" href="cpp2for_8cpp.html#43016d873124d39034edb8cd164794db">pi</a>=3.14159265358979323846;
  
  <span class="keyword">using namespace </span><a name="_a2"></a><a class="code" href="classMConf_1_1Vector3d.html" title="This class provides 3d-vector type.">MConf::Vector3d</a>;
  
  <span class="keywordflow">if</span>(argc &lt; 3) {
     puts(<span class="stringliteral">"remesh bc-file,  version 1.0  Yuriy Turkin,2004\n\n"</span>
     <span class="stringliteral">"Syntax: remesh inFile outFile [ tolerance [#_of_surfaces] ] \n"</span>
     <span class="stringliteral">"        remesh w7x-sc1.bc  w7x-sc1(reduced).bc  1e-6  30\n"</span>);
     exit(1);
   }

  <span class="keywordtype">double</span> epsTrunc = 1e-5;         <span class="comment">// Fourier spectrum truncation level</span>
  <span class="keywordtype">int</span> Nsurf = 30;                 <span class="comment">// number of surfaces to write</span>
  <span class="keywordtype">char</span> *fname         = argv[1];
  <span class="keywordtype">char</span> *fnameReduced  = argv[2];
  <span class="keywordflow">if</span>(argc &gt; 3) epsTrunc = atof(argv[3]);
  <span class="keywordflow">if</span>(argc &gt; 4) Nsurf = atoi(argv[4]);

  clock_t tStart = clock();

  <a name="_a3"></a><a class="code" href="classMConf_1_1CStconfig.html" title="Magnetic configuration of a stellarator.">MConf::CStconfig</a> mConf;
  mConf.<a name="a4"></a><a class="code" href="classMConf_1_1CStconfig.html#071b9a97170fd011e61fedaa0aae2dbc" title="The method loads the magnetic configuration stored in the file filename.">load</a> (fname);
  <span class="keywordflow">if</span>(!mConf.<a name="a5"></a><a class="code" href="classMConf_1_1CStconfig.html#78990418d548a9f25399f370f2d2d482" title="The method returns true if file is loaded without error.">isOK</a>()) {printf(<span class="stringliteral">"%s : Loading error\n"</span>,fname);<span class="keywordflow">return</span> 1;}

  printf(<span class="stringliteral">"%s is loaded, time=%g\n"</span>, fname, <span class="keywordtype">double</span>(clock()-tStart)/CLOCKS_PER_SEC);

  mConf.<a name="a6"></a><a class="code" href="classMConf_1_1CStconfig.html#e2619b12739acde2fd428a2d976b8e10" title="Set truncation level to reduce number of harmonics used in summation.">truncate</a>(epsTrunc);           <span class="comment">// truncate spectrum</span>

  mConf.<a name="a7"></a><a class="code" href="classMConf_1_1CStconfig.html#5ff612ea1be83bd73c096ccf7d2a3172" title="The methods transform the current magnetic configuration to new volume or to new...">writeasciiReduced</a>(fnameReduced,Nsurf,0,1,<span class="keyword">true</span>,<span class="keyword">true</span>);

  printf(<span class="stringliteral">"%s  is saved\n"</span>,fnameReduced);

  mConf.<a class="code" href="classMConf_1_1CStconfig.html#e2619b12739acde2fd428a2d976b8e10" title="Set truncation level to reduce number of harmonics used in summation.">truncate</a>(1e-15);           <span class="comment">// restore truncation level</span>

  printf(<span class="stringliteral">"\nTesting accuracy of remeshing. Please wait.........\n"</span>);

  tStart = clock();

  <a class="code" href="classMConf_1_1CStconfig.html" title="Magnetic configuration of a stellarator.">MConf::CStconfig</a> mConfReduced;
  mConfReduced.<a class="code" href="classMConf_1_1CStconfig.html#071b9a97170fd011e61fedaa0aae2dbc" title="The method loads the magnetic configuration stored in the file filename.">load</a>(fnameReduced);      <span class="comment">// load new file</span>
  <span class="keywordflow">if</span>(!mConfReduced.<a class="code" href="classMConf_1_1CStconfig.html#78990418d548a9f25399f370f2d2d482" title="The method returns true if file is loaded without error.">isOK</a>()) {printf(<span class="stringliteral">"%s : Loading error\n"</span>,fnameReduced); <span class="keywordflow">return</span> 1;}

  printf(<span class="stringliteral">"%s is loaded, time=%g\n"</span>, fnameReduced, <span class="keywordtype">double</span>(clock()-tStart)/CLOCKS_PER_SEC);

  printf(<span class="stringliteral">"\n**********Accuracy of remeshing*************\n"</span>);
  printf(<span class="stringliteral">"   s     err(xyz)   err(|B|)   err(Jacobian)\n"</span>);

  SeedRandom(0);
  <span class="keywordtype">int</span> maxVectors = 500;
  <span class="keywordtype">double</span> errR=0, errB=0, errJ=0;
  <span class="keywordtype">int</span> is,i, np = mConf.<a name="a8"></a><a class="code" href="classMConf_1_1CStconfig.html#3e72809526645c891739ca6c93e3c0de" title="The method returns the number of periods.">nPeriods</a>();      <span class="comment">// # of periods</span>
  <span class="keywordflow">for</span>(is=0; is&lt;10; is++) {
    <span class="keywordtype">double</span> s1 = is*0.1;
    <span class="keywordtype">double</span> ds = 0.1;
    errR=errB=errJ=0;
    <span class="keywordflow">for</span>(i=0; i&lt;maxVectors; i++) {
      Vector3d booz = Vector3d(s1+ds*Random(),Random()*2*pi,Random()*2*pi/np); <span class="comment">// random Boozer vector </span>
      Vector3d R1 = mConf.<a name="a9"></a><a class="code" href="classMConf_1_1CStconfig.html#f9d57bc16554663cda6e627a3b4d95e6" title="The method returns the cartesian coordinates of the point.">mag2xyz</a>(booz);         <span class="comment">// calculate cartesian coordinales</span>
      Vector3d R2 = mConfReduced.<a class="code" href="classMConf_1_1CStconfig.html#f9d57bc16554663cda6e627a3b4d95e6" title="The method returns the cartesian coordinates of the point.">mag2xyz</a>(booz);  <span class="comment">// calculate cartesian coordinales</span>
      <span class="keywordtype">double</span> B1 = mConf.<a name="a10"></a><a class="code" href="classMConf_1_1CStconfig.html#71ca6daedc947973fdb6538af01c17aa" title="The function returns B=sum_mn B_mn(s)*cos(m*theta-n*Np*phi).">B</a>(booz);         <span class="comment">// calculate |B|</span>
      <span class="keywordtype">double</span> B2 = mConfReduced.<a class="code" href="classMConf_1_1CStconfig.html#71ca6daedc947973fdb6538af01c17aa" title="The function returns B=sum_mn B_mn(s)*cos(m*theta-n*Np*phi).">B</a>(booz);  <span class="comment">// calculate |B|</span>
      <span class="keywordtype">double</span> J1 = mConf.<a name="a11"></a><a class="code" href="classMConf_1_1CStconfig.html#b06b5a7dac1e2b09c117db41c529cd45" title="Jacobian: dV = Jacobian(s,theta,phi)*ds*dtheta*dphi.">Jacobian</a>(booz);
      <span class="keywordtype">double</span> J2 = mConfReduced.<a class="code" href="classMConf_1_1CStconfig.html#b06b5a7dac1e2b09c117db41c529cd45" title="Jacobian: dV = Jacobian(s,theta,phi)*ds*dtheta*dphi.">Jacobian</a>(booz);
      errR = <a class="code" href="cpp2for_8cpp.html#42af2ca7ecd9ddfa9c9a609023ee50bb">mmax</a>(errR,(R2-R1).abs());
      errB = <a class="code" href="cpp2for_8cpp.html#42af2ca7ecd9ddfa9c9a609023ee50bb">mmax</a>(errB,fabs(B2-B1));
      errJ = <a class="code" href="cpp2for_8cpp.html#42af2ca7ecd9ddfa9c9a609023ee50bb">mmax</a>(errJ,fabs(J2-J1));
    }
    printf(<span class="stringliteral">"%3.1f-%3.1f  %6.2e  %6.2e  %6.2e\n"</span>,s1,s1+ds,errR,errB,errJ);
  }
  printf(<span class="stringliteral">"\nNumber of random point processed=%d\n\n"</span>,10*maxVectors);
  printf(<span class="stringliteral">"\nDone! see file %s\n"</span>,fnameReduced);

  <span class="keywordflow">return</span> 0;
}


<span class="comment">//******************************************************************</span>
<span class="comment">// Set random starting point.</span>
<span class="comment">//  srand()  from &lt;stdlib.h&gt;</span>
<span class="comment">// if sw==0  then random seed value</span>
<span class="keywordtype">void</span> SeedRandom(<span class="keywordtype">int</span> sw=0)
{
  <span class="keywordflow">if</span>(sw)  srand(sw);
  <span class="keywordflow">else</span>    srand((<span class="keywordtype">unsigned</span>)time(NULL));
}
<span class="comment">//******************************************************************</span>
<span class="comment">// Returns uniformly distributed random number between 0 and 1</span>
<span class="comment">//  rand() from &lt;stdlib.h&gt;</span>
<span class="keywordtype">double</span> Random(<span class="keywordtype">void</span>)
{
  <span class="keyword">static</span> <span class="keywordtype">double</span> norm = 1./(double)RAND_MAX;
  <span class="keywordflow">return</span> rand()*norm;
}

</pre></div> </div>
    <p><a class="anchor" name="BottomOfPage"></a></p>
    <div class="no-print" align="right">
      <table border="0">
        <tr>
        <td>[ <a class="el" href="#TopOfPage">top</a> ]</td>
        <td>[ <a class="el" href="javascript:history.back(-1);"><b>back</b></a> ]</td> 
        </tr>
      </table>
    </div>
    <hr class="separator">
    <div class="ippAddress" align="right">
      <table border="0">
        <tr>
          <td class="ippAddress">13 Oct 2021 &nbsp;&nbsp;&nbsp;&nbsp;</td>
          <td class="ippAddress">
            <a href="http://www.ipp.mpg.de"><img src="IPP.png" alt="www.ipp.mpg.de" border="0"></a>
          </td>
          <td class="ippAddress">
            <!-- Copyright &copy; 2005-2008<br> --> 
            Max-Planck-Institut<br>f&uuml;r Plasmaphysik
          </td>
        </tr>
      </table>
    </div>
  </div>
</div>
</body>
</html>
