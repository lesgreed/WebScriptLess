<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <title>MConf: CBtrace.h Source File</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <meta name="author" content="Yuriy Turkin">
  <meta name="keywords" content="stellarator, w7x, W7-X, W7-X software">
  <meta name="description" content="W7-X Software">
  <link href="myCss.css" rel="stylesheet" type="text/css">
  <link href="tabs.css" rel="stylesheet" type="text/css" >
</head>
<body>
  <div class="centerAll" id="TopOfPage">
    <div class="bodyForAll">
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_8a58aa3034da50da28943871e9137c86.html">include</a>
  </div>
</div>
<div class="contents">
<h1>CBtrace.h</h1><a href="CBtrace_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#ifndef MC_CBtrace_</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor">#define MC_CBtrace_</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span>
<a name="l00004"></a>00004 <span class="preprocessor">#include "<a class="code" href="CVector3d_8h.html">CVector3d.h</a>"</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include "<a class="code" href="rkf45_8h.html">rkf45.h</a>"</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="keyword">namespace </span>MConf {
<a name="l00008"></a>00008 
<a name="l00009"></a><a class="code" href="CBtrace_8h.html#3962a902e4089c7604c706d80e4f0ceb">00009</a> <span class="preprocessor">#define USE_RKF45 1</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span>
<a name="l00011"></a><a class="code" href="namespaceMConf.html#13f49a57d6654856ffcbc86ae0fa2ebb">00011</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="namespaceMConf.html#13f49a57d6654856ffcbc86ae0fa2ebb">nODE</a>=2;
<a name="l00012"></a><a class="code" href="namespaceMConf.html#c714261b7da0f8f3770854f41add5a6c">00012</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceMConf.html#c714261b7da0f8f3770854f41add5a6c">ATOL</a>=1e-10; <span class="comment">//1e-8;</span>
<a name="l00013"></a><a class="code" href="namespaceMConf.html#3d382ee7bf4b65eb2a378e920e9e8cac">00013</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> <a class="code" href="namespaceMConf.html#3d382ee7bf4b65eb2a378e920e9e8cac">RTOL</a>=1e-10; <span class="comment">//1e-9;</span>
<a name="l00014"></a>00014 
<a name="l00015"></a>00015 <span class="comment">//***************************************************************************</span>
<a name="l00051"></a>00051 <span class="comment"></span>
<a name="l00052"></a><a class="code" href="classMConf_1_1CBtrace.html">00052</a> <span class="keyword">template</span> &lt;<span class="keyword">class</span> Bfield&gt; <span class="keyword">class </span><a class="code" href="classMConf_1_1CBtrace.html" title="The class is used for B-field line tracing.">CBtrace</a>
<a name="l00053"></a>00053 {
<a name="l00054"></a>00054   <span class="keywordtype">void</span> init_(<span class="keywordtype">double</span> fiStep=0.0017453,<span class="keywordtype">double</span> atol=<a class="code" href="namespaceMConf.html#c714261b7da0f8f3770854f41add5a6c">ATOL</a>,<span class="keywordtype">double</span> rtol=<a class="code" href="namespaceMConf.html#3d382ee7bf4b65eb2a378e920e9e8cac">RTOL</a>) {
<a name="l00055"></a>00055     twopi=6.283185307179586476925286766559;
<a name="l00056"></a>00056     this-&gt;a_tol=atol;
<a name="l00057"></a>00057     this-&gt;r_tol=rtol;
<a name="l00058"></a>00058     h = fiStep==0?1e-3:fiStep;
<a name="l00059"></a>00059     q = 1;
<a name="l00060"></a>00060     Bfld = 0;
<a name="l00061"></a>00061 <span class="preprocessor">#if USE_RKF45</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span>    rhs.init(Bfld);
<a name="l00063"></a>00063     rkf.<a class="code" href="classMConf_1_1rkf45.html#c4c5c7481372294c326c68d50faee4a9">init</a>(&amp;rhs,2,atol,rtol);
<a name="l00064"></a>00064 <span class="preprocessor">#endif</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>  }
<a name="l00066"></a>00066 <span class="keyword">public</span>:
<a name="l00067"></a><a class="code" href="classMConf_1_1CBtrace.html#9aefe71f96c0b4928928aa16a71c24f3">00067</a>   <a class="code" href="classMConf_1_1CBtrace.html#9aefe71f96c0b4928928aa16a71c24f3">CBtrace</a>() { init_(); }
<a name="l00081"></a><a class="code" href="classMConf_1_1CBtrace.html#51b1ed3e30d2256b477c9232ecf84207">00081</a>   <a class="code" href="classMConf_1_1CBtrace.html#51b1ed3e30d2256b477c9232ecf84207" title="The constructor creates an instance of tracing object.">CBtrace</a>(Bfield &amp;B, <span class="keywordtype">double</span> fiStep=0.0017453) {
<a name="l00082"></a>00082     init_(fiStep);
<a name="l00083"></a>00083     this-&gt;Bfld=&amp;B;
<a name="l00084"></a>00084 <span class="preprocessor">#if USE_RKF45</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span>    rhs.init(&amp;B);
<a name="l00086"></a>00086     rkf.<a class="code" href="classMConf_1_1rkf45.html#c4c5c7481372294c326c68d50faee4a9">init</a>(&amp;rhs,2);
<a name="l00087"></a>00087 <span class="preprocessor">#endif</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span>  }
<a name="l00089"></a><a class="code" href="classMConf_1_1CBtrace.html#fc77457b3eaa48d53f869a4ea9c288d6">00089</a>   <span class="keyword">virtual</span> <a class="code" href="classMConf_1_1CBtrace.html#fc77457b3eaa48d53f869a4ea9c288d6">~CBtrace</a>() {;}
<a name="l00090"></a><a class="code" href="classMConf_1_1CBtrace.html#d2581f970fbcf3b72f40d4e1e2b0737b">00090</a>   <span class="keywordtype">void</span> <a class="code" href="classMConf_1_1CBtrace.html#d2581f970fbcf3b72f40d4e1e2b0737b">init</a>(Bfield &amp;B,<span class="keywordtype">double</span> fiStep=0.0017453,<span class="keywordtype">double</span> atol=<a class="code" href="namespaceMConf.html#c714261b7da0f8f3770854f41add5a6c">ATOL</a>,<span class="keywordtype">double</span> rtol=<a class="code" href="namespaceMConf.html#3d382ee7bf4b65eb2a378e920e9e8cac">RTOL</a>) {
<a name="l00091"></a>00091     init_(fiStep,atol,rtol);
<a name="l00092"></a>00092     this-&gt;Bfld=&amp;B;
<a name="l00093"></a>00093 <span class="preprocessor">#if USE_RKF45</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span>    rhs.init(&amp;B);
<a name="l00095"></a>00095     rkf.<a class="code" href="classMConf_1_1rkf45.html#c4c5c7481372294c326c68d50faee4a9">init</a>(&amp;rhs,2,atol,rtol);
<a name="l00096"></a>00096 <span class="preprocessor">#endif</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>  }
<a name="l00098"></a><a class="code" href="classMConf_1_1CBtrace.html#02fd73d861ef2e4aabb38c0c9ff82947">00098</a>   <span class="keywordtype">void</span> <a class="code" href="classMConf_1_1CBtrace.html#02fd73d861ef2e4aabb38c0c9ff82947">init</a>() {
<a name="l00099"></a>00099 <span class="preprocessor">#if USE_RKF45</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span>    rkf.<a class="code" href="classMConf_1_1rkf45.html#c4c5c7481372294c326c68d50faee4a9">init</a>();
<a name="l00101"></a>00101 <span class="preprocessor">#endif</span>
<a name="l00102"></a>00102 <span class="preprocessor"></span>  }
<a name="l00103"></a><a class="code" href="classMConf_1_1CBtrace.html#b08f4a9c4d7d0dc17c3d20fc4ecfd11a">00103</a>   <span class="keywordtype">void</span> <a class="code" href="classMConf_1_1CBtrace.html#b08f4a9c4d7d0dc17c3d20fc4ecfd11a">setStep</a>(<span class="keywordtype">double</span> fiStep) { h = fiStep==0?1e-3:fiStep;  }
<a name="l00104"></a>00104   <span class="comment">//***************************************************************************</span>
<a name="l00105"></a>00105   <span class="comment">// input: dfi -- cylindrical angle increment</span>
<a name="l00106"></a>00106   <span class="comment">// input: cyl -- cylindrical coordinates of magnetic field line</span>
<a name="l00107"></a>00107   <span class="comment">// output cyl -- cylindrical coordinates of magnetic field line after dfi</span>
<a name="l00108"></a><a class="code" href="classMConf_1_1CBtrace.html#b9af0dcaabe35aa183feccd81b35e47b">00108</a>   <span class="keywordtype">void</span> <a class="code" href="classMConf_1_1CBtrace.html#b9af0dcaabe35aa183feccd81b35e47b">advance</a>(<span class="keywordtype">double</span> dfi, <a class="code" href="classMConf_1_1Vector3d.html" title="This class provides 3d-vector type.">Vector3d</a> &amp;cyl)
<a name="l00109"></a>00109   {
<a name="l00110"></a>00110     q = 1;
<a name="l00111"></a>00111     <span class="keywordtype">double</span> fi;
<a name="l00112"></a>00112     y[0] = cyl[0]; <span class="comment">// r; // set initial values</span>
<a name="l00113"></a>00113     fi   = cyl[1]; <span class="comment">// fi</span>
<a name="l00114"></a>00114     y[1] = cyl[2]; <span class="comment">// z;</span>
<a name="l00115"></a>00115     <span class="keywordtype">double</span> fiEnd=fi+dfi;
<a name="l00116"></a>00116 <span class="preprocessor">#if USE_RKF45</span>
<a name="l00117"></a>00117 <span class="preprocessor"></span>    rhs.setq(q);
<a name="l00118"></a>00118     rkf.<a class="code" href="classMConf_1_1rkf45.html#37ed1079eca189fb1c85f0c2cd837b5f">advance</a>(y,fi,fiEnd);
<a name="l00119"></a>00119 <span class="preprocessor">#else</span>
<a name="l00120"></a>00120 <span class="preprocessor"></span>    RKutt(fi,fiEnd,h);    <span class="comment">// solve from fi to fiEnd</span>
<a name="l00121"></a>00121 <span class="preprocessor">#endif</span>
<a name="l00122"></a>00122 <span class="preprocessor"></span>  <span class="comment">//  Adams4(fi,fiEnd,h);    // solve from fi to fiEnd</span>
<a name="l00123"></a>00123     cyl[0] = y[0];   <span class="comment">// r</span>
<a name="l00124"></a>00124     cyl[1] = fiEnd;  <span class="comment">// fi</span>
<a name="l00125"></a>00125     cyl[2] = y[1];   <span class="comment">// z</span>
<a name="l00126"></a>00126   }
<a name="l00127"></a>00127 
<a name="l00128"></a>00128   <span class="comment">//***************************************************************************</span>
<a name="l00129"></a>00129   <span class="comment">// Tracing along poloidal angle is valid only for straight field line coordinates.</span>
<a name="l00130"></a>00130   <span class="comment">// advancePoloidally -- use for tokamak only!</span>
<a name="l00131"></a>00131   <span class="comment">// input: dtheta -- poloidal angle increment</span>
<a name="l00132"></a>00132   <span class="comment">// input: q -- safety factor</span>
<a name="l00133"></a>00133   <span class="comment">// input: cyl -- cylindrical coordinates of magnetic field line</span>
<a name="l00134"></a>00134   <span class="comment">//        cyl[1] is the poloidal angle theta: nothing depend on cyl.angle, so we use cyl[1] for poloidal angle</span>
<a name="l00135"></a>00135   <span class="comment">// output: cyl -- cylindrical coordinates of magnetic field line after dtheta-step</span>
<a name="l00136"></a>00136   <span class="comment">//        cyl[1] is the poloidal angle theta: nothing depend on cyl.angle, so we use cyl[1] for poloidal angle</span>
<a name="l00137"></a><a class="code" href="classMConf_1_1CBtrace.html#46d26bb81261e78070e717e09bf5a57f">00137</a>   <span class="keywordtype">void</span> <a class="code" href="classMConf_1_1CBtrace.html#46d26bb81261e78070e717e09bf5a57f">advancePoloidally</a>(<span class="keywordtype">double</span> dtheta, <span class="keywordtype">double</span> q, <a class="code" href="classMConf_1_1Vector3d.html" title="This class provides 3d-vector type.">Vector3d</a> &amp;cyl)
<a name="l00138"></a>00138   {
<a name="l00139"></a>00139     this-&gt;q=q;
<a name="l00140"></a>00140     <span class="keywordtype">double</span> th;
<a name="l00141"></a>00141     y[0] = cyl[0]; <span class="comment">// r; // set initial values</span>
<a name="l00142"></a>00142     th   = cyl[1]; <span class="comment">// theta: nothing depend on cyl.angle, so we use cyl[1] for poloidal angle</span>
<a name="l00143"></a>00143     y[1] = cyl[2]; <span class="comment">// z;</span>
<a name="l00144"></a>00144     <span class="keywordtype">double</span> thEnd=th+dtheta;
<a name="l00145"></a>00145 <span class="preprocessor">#if USE_RKF45</span>
<a name="l00146"></a>00146 <span class="preprocessor"></span>    rhs.setq(q);
<a name="l00147"></a>00147     rkf.<a class="code" href="classMConf_1_1rkf45.html#37ed1079eca189fb1c85f0c2cd837b5f">advance</a>(y,th,thEnd);
<a name="l00148"></a>00148 <span class="preprocessor">#else</span>
<a name="l00149"></a>00149 <span class="preprocessor"></span>    RKutt(th,thEnd,h);    <span class="comment">// solve from th to thEnd</span>
<a name="l00150"></a>00150 <span class="preprocessor">#endif</span>
<a name="l00151"></a>00151 <span class="preprocessor"></span>  <span class="comment">//  Adams4(th,thEnd,h);    // solve from th to thEnd</span>
<a name="l00152"></a>00152     cyl[0] = y[0];   <span class="comment">// r</span>
<a name="l00153"></a>00153     cyl[1] = thEnd;  <span class="comment">// theta</span>
<a name="l00154"></a>00154     cyl[2] = y[1];   <span class="comment">// z</span>
<a name="l00155"></a>00155   }
<a name="l00156"></a>00156 
<a name="l00157"></a>00157 <span class="keyword">private</span>:
<a name="l00158"></a>00158   Bfield *Bfld;  <span class="comment">// Function object returns vector of magnetic field for given point in cylindrical coordinates.</span>
<a name="l00159"></a>00159 
<a name="l00160"></a>00160   <span class="keywordtype">double</span> y[<a class="code" href="namespaceMConf.html#13f49a57d6654856ffcbc86ae0fa2ebb">nODE</a>];                <span class="comment">// we solve dy/dx = F(y,x)</span>
<a name="l00161"></a>00161   <span class="keywordtype">double</span> a_tol, r_tol;
<a name="l00162"></a>00162   <span class="keywordtype">double</span> h;                       <span class="comment">// step</span>
<a name="l00163"></a>00163   <span class="keywordtype">double</span> twopi;
<a name="l00164"></a>00164   <span class="keywordtype">double</span> q;     <span class="comment">// 1/iota;</span>
<a name="l00165"></a>00165 
<a name="l00166"></a>00166 <span class="preprocessor">#if USE_RKF45</span>
<a name="l00167"></a>00167 <span class="preprocessor"></span>  <span class="keyword">class </span>RightHand: <span class="keyword">public</span> <a class="code" href="classMConf_1_1RightHandSide.html">RightHandSide</a> {
<a name="l00168"></a>00168     Bfield *Bfld;
<a name="l00169"></a>00169     <span class="keywordtype">double</span> q;     <span class="comment">// 1/iota;</span>
<a name="l00170"></a>00170   <span class="keyword">public</span>:
<a name="l00171"></a>00171     RightHand() { Bfld = 0; q = 1;}
<a name="l00172"></a>00172     <span class="keywordtype">void</span> <a class="code" href="classMConf_1_1CBtrace.html#02fd73d861ef2e4aabb38c0c9ff82947">init</a>(Bfield *B, <span class="keywordtype">double</span> q=1) { Bfld = B; this-&gt;q = q;}
<a name="l00173"></a>00173     <span class="keywordtype">void</span> setq(<span class="keywordtype">double</span> q) { this-&gt;q = q;}
<a name="l00174"></a>00174     <span class="keywordtype">void</span> operator() (<span class="keywordtype">double</span> fi,<span class="keyword">const</span> <span class="keywordtype">double</span> *y,<span class="keywordtype">double</span> *yp) { 
<a name="l00175"></a>00175       <span class="keywordtype">double</span> w;
<a name="l00176"></a>00176       Vector3d c(y[0],fi,y[1]); <span class="comment">// c==(r,fi,z)</span>
<a name="l00177"></a>00177       Vector3d B = (*Bfld)(c);
<a name="l00178"></a>00178       <span class="keywordflow">if</span>(B[1]==0)
<a name="l00179"></a>00179         w=0;
<a name="l00180"></a>00180       <span class="keywordflow">else</span>
<a name="l00181"></a>00181         w=q*y[0]/B[1];     <span class="comment">// q*r/Bfi, where q = 1/iota</span>
<a name="l00182"></a>00182       yp[0]=w*B[0];        <span class="comment">// dr/dfi = q*r*Br/Bfi</span>
<a name="l00183"></a>00183       yp[1]=w*B[2];        <span class="comment">// dz/dfi = q*r*Bz/Bfi     </span>
<a name="l00184"></a>00184     }
<a name="l00185"></a>00185   };
<a name="l00186"></a>00186 
<a name="l00187"></a>00187   RightHand rhs;
<a name="l00188"></a>00188   rkf45 rkf;
<a name="l00189"></a>00189 <span class="preprocessor">#else</span>
<a name="l00190"></a>00190 <span class="preprocessor"></span>  <span class="keywordtype">double</span> y1[<a class="code" href="namespaceMConf.html#13f49a57d6654856ffcbc86ae0fa2ebb">nODE</a>],u[<a class="code" href="namespaceMConf.html#13f49a57d6654856ffcbc86ae0fa2ebb">nODE</a>],r[<a class="code" href="namespaceMConf.html#13f49a57d6654856ffcbc86ae0fa2ebb">nODE</a>];            <span class="comment">//</span>
<a name="l00191"></a>00191   <span class="keywordtype">double</span> f0[<a class="code" href="namespaceMConf.html#13f49a57d6654856ffcbc86ae0fa2ebb">nODE</a>],f1[<a class="code" href="namespaceMConf.html#13f49a57d6654856ffcbc86ae0fa2ebb">nODE</a>],f2[<a class="code" href="namespaceMConf.html#13f49a57d6654856ffcbc86ae0fa2ebb">nODE</a>],f3[<a class="code" href="namespaceMConf.html#13f49a57d6654856ffcbc86ae0fa2ebb">nODE</a>]; <span class="comment">// f0[nODE], .. -- for Adams method</span>
<a name="l00192"></a>00192   <span class="comment">//***************************************************************************</span>
<a name="l00193"></a>00193   <span class="comment">// B-field line tracing</span>
<a name="l00194"></a>00194   <span class="comment">//  dr/dth=Br*q*r/Bfi</span>
<a name="l00195"></a>00195   <span class="comment">//  dz/dth=Bz*q*r/Bfi</span>
<a name="l00196"></a>00196   <span class="comment">//</span>
<a name="l00197"></a>00197   <span class="comment">//  dy = dfi*F(y,fi), where dy/dfi = F(y,fi)</span>
<a name="l00198"></a>00198   <span class="comment">//  q is the safity factor.</span>
<a name="l00199"></a>00199   <span class="comment">//  fi is the cylindrical(toroidal) angle</span>
<a name="l00200"></a>00200   <span class="comment">//  fi = q*th</span>
<a name="l00201"></a>00201   <span class="comment">//  th is the poloidal angle</span>
<a name="l00202"></a>00202   <span class="comment">//  normally q=1, in this case th must be treated as toroidal angle fi. </span>
<a name="l00203"></a>00203   <span class="comment">// Tracing along poloidal angle is valid only for straight field line coordinates.</span>
<a name="l00204"></a>00204   <span class="keywordtype">void</span> RHS(<span class="keywordtype">double</span> fi,<span class="keywordtype">double</span> dfi,<span class="keywordtype">double</span> *y,<span class="keywordtype">double</span> *dy)
<a name="l00205"></a>00205   {
<a name="l00206"></a>00206   <span class="comment">//  double r = y[0];</span>
<a name="l00207"></a>00207   <span class="comment">//  double z = y[1];</span>
<a name="l00208"></a>00208     Vector3d c(y[0],fi,y[1]);
<a name="l00209"></a>00209     Vector3d B = (*Bfld)(c);
<a name="l00210"></a>00210     <span class="keywordflow">if</span>(B[1]==0)
<a name="l00211"></a>00211       dfi=0;
<a name="l00212"></a>00212     <span class="keywordflow">else</span>
<a name="l00213"></a>00213       dfi *= q*y[0]/B[1];  <span class="comment">// q*r/Bfi, where q = 1/iota</span>
<a name="l00214"></a>00214     dy[0]=dfi*B[0];        <span class="comment">// dr = dfi*q*r*Br/Bfi</span>
<a name="l00215"></a>00215     dy[1]=dfi*B[2];        <span class="comment">// dz = dfi*q*r*Bz/Bfi</span>
<a name="l00216"></a>00216   }
<a name="l00217"></a>00217 
<a name="l00218"></a>00218   <span class="comment">//***************************************************************************</span>
<a name="l00219"></a>00219   <span class="comment">// input: y[] at x; dx is the step</span>
<a name="l00220"></a>00220   <span class="comment">// output y[] at xend</span>
<a name="l00221"></a>00221   <span class="keywordtype">void</span> RKutt(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> xend,<span class="keywordtype">double</span> dx)
<a name="l00222"></a>00222   {
<a name="l00223"></a>00223     <span class="keywordtype">int</span> n,N = int(fabs((xend-x)/dx));
<a name="l00224"></a>00224     <span class="keywordflow">if</span>(N&gt;0)
<a name="l00225"></a>00225       dx = (xend-x)/N;
<a name="l00226"></a>00226     <span class="keywordflow">else</span> {
<a name="l00227"></a>00227       dx=xend-x;
<a name="l00228"></a>00228       N=1;
<a name="l00229"></a>00229     }
<a name="l00230"></a>00230     <span class="keywordflow">for</span>(n=0;n&lt;N;n++) RKutt1step(x,dx);
<a name="l00231"></a>00231   }
<a name="l00232"></a>00232 
<a name="l00233"></a>00233   <span class="comment">//***************************************************************************</span>
<a name="l00234"></a>00234   <span class="comment">// one step integrator</span>
<a name="l00235"></a>00235   <span class="comment">// input:  y[] at x; dx is the step</span>
<a name="l00236"></a>00236   <span class="comment">// output: y[] at x=x+dx, function updates x</span>
<a name="l00237"></a>00237   <span class="keywordtype">void</span> RKutt1step(<span class="keywordtype">double</span> &amp;x, <span class="keywordtype">double</span> dx)
<a name="l00238"></a>00238   {
<a name="l00239"></a>00239     <span class="keywordtype">int</span> i;
<a name="l00240"></a>00240     RHS(x,dx, y,u);                 <span class="comment">// r1 = u = dx*f(y,x)</span>
<a name="l00241"></a>00241     <span class="keywordflow">for</span>(i=0; i&lt;<a class="code" href="namespaceMConf.html#13f49a57d6654856ffcbc86ae0fa2ebb">nODE</a>; i++)
<a name="l00242"></a>00242       y1[i] = y[i] + u[i]/2.;       <span class="comment">// y1 = y + r1/2</span>
<a name="l00243"></a>00243     RHS(x+dx/2,dx, y1,r);           <span class="comment">// r2 = dx*f(y+r1/2,x+dx/2)</span>
<a name="l00244"></a>00244     <span class="keywordflow">for</span>(i=0; i&lt;nODE; i++)  {
<a name="l00245"></a>00245       y1[i] = y[i] + r[i]/2.;       <span class="comment">// y1 = y + r2/2</span>
<a name="l00246"></a>00246       u[i] += 2.*r[i];              <span class="comment">// u = r1 + 2*r2</span>
<a name="l00247"></a>00247       }
<a name="l00248"></a>00248     RHS(x+dx/2,dx, y1,r);           <span class="comment">// r3 = dx*f(y+r2/2,x+dx/2)</span>
<a name="l00249"></a>00249     <span class="keywordflow">for</span>(i=0; i&lt;nODE; i++)  {
<a name="l00250"></a>00250       y1[i] = y[i] + r[i];          <span class="comment">// y1 = y + r3</span>
<a name="l00251"></a>00251       u[i] += 2.*r[i];              <span class="comment">// u = r1 + 2*r2 + 2*r3</span>
<a name="l00252"></a>00252       }
<a name="l00253"></a>00253     RHS(x+dx,dx, y1,r);             <span class="comment">// r4 = dx*f(y+r3,x+dx)</span>
<a name="l00254"></a>00254     <span class="keywordflow">for</span>(i=0; i&lt;nODE; i++)
<a name="l00255"></a>00255       y[i] += (u[i] + r[i])/6;      <span class="comment">// y = y + (r1 + 2*r2 + 2*r3 + r4)/6</span>
<a name="l00256"></a>00256     x += dx;
<a name="l00257"></a>00257   }
<a name="l00258"></a>00258 <span class="preprocessor">#endif</span>
<a name="l00259"></a>00259 <span class="preprocessor"></span>
<a name="l00260"></a>00260   <span class="keyword">private</span>: <span class="comment">// obsolete or not used</span>
<a name="l00261"></a>00261 <span class="preprocessor">#if 0</span>
<a name="l00262"></a>00262 <span class="preprocessor"></span>  <span class="comment">//***************************************************************************</span>
<a name="l00263"></a>00263   <span class="comment">// input: cyl -- cylindrical coordinates of magnetic field line</span>
<a name="l00264"></a>00264   <span class="comment">// output cyl -- cylindrical coordinates of magnetic field line after toroidal turn</span>
<a name="l00265"></a>00265   <span class="keywordtype">void</span> advance2pi_not_used(Vector3d &amp;cyl)
<a name="l00266"></a>00266   {
<a name="l00267"></a>00267     q = 1;
<a name="l00268"></a>00268     <span class="keywordtype">double</span> fi;
<a name="l00269"></a>00269     y[0] = cyl[0]; <span class="comment">// r; // set initial values</span>
<a name="l00270"></a>00270     fi   = cyl[1]; <span class="comment">// fi</span>
<a name="l00271"></a>00271     y[1] = cyl[2]; <span class="comment">// z;</span>
<a name="l00272"></a>00272     <span class="keywordtype">double</span> fiEnd=fi+twopi;
<a name="l00273"></a>00273     RKutt(fi,fiEnd,h);    <span class="comment">// solve from fi to fiEnd</span>
<a name="l00274"></a>00274   <span class="comment">//  Adams4(fi,fiEnd,h);    // solve from fi to fiEnd</span>
<a name="l00275"></a>00275     cyl[0] = y[0];   <span class="comment">// r</span>
<a name="l00276"></a>00276   <span class="comment">//cyl[1] = fiEnd;  // fi</span>
<a name="l00277"></a>00277     cyl[2] = y[1];   <span class="comment">// z</span>
<a name="l00278"></a>00278   }
<a name="l00279"></a>00279 
<a name="l00280"></a>00280   <span class="comment">//***************************************************************************</span>
<a name="l00281"></a>00281   <span class="comment">// input: dfi -- cylindrical angle increment</span>
<a name="l00282"></a>00282   <span class="comment">// input: cyl -- cylindrical coordinates of magnetic field line</span>
<a name="l00283"></a>00283   <span class="comment">// output cyl -- cylindrical coordinates of magnetic field line after dfi</span>
<a name="l00284"></a>00284   <span class="keywordtype">void</span> advance1step_not_used(<span class="keywordtype">double</span> dfi, Vector3d &amp;cyl)
<a name="l00285"></a>00285   {
<a name="l00286"></a>00286     q = 1;
<a name="l00287"></a>00287     <span class="keywordtype">double</span> fi;
<a name="l00288"></a>00288     y[0] = cyl[0]; <span class="comment">// r; // set initial values</span>
<a name="l00289"></a>00289     fi   = cyl[1]; <span class="comment">// fi</span>
<a name="l00290"></a>00290     y[1] = cyl[2]; <span class="comment">// z;</span>
<a name="l00291"></a>00291     RKutt1step(fi,dfi);    <span class="comment">// solve from fi to fi+dfi</span>
<a name="l00292"></a>00292     cyl[0] = y[0];    <span class="comment">// r</span>
<a name="l00293"></a>00293     cyl[1] = fi;      <span class="comment">// fi</span>
<a name="l00294"></a>00294     cyl[2] = y[1];    <span class="comment">// z</span>
<a name="l00295"></a>00295   }
<a name="l00296"></a>00296 
<a name="l00297"></a>00297   <span class="comment">//***************************************************************************</span>
<a name="l00298"></a>00298   <span class="comment">// input: y[] at x; dx is the step</span>
<a name="l00299"></a>00299   <span class="comment">// output y[] at xend</span>
<a name="l00300"></a>00300   <span class="keywordtype">void</span> Adams4(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> xend,<span class="keywordtype">double</span> dx)
<a name="l00301"></a>00301   {
<a name="l00302"></a>00302     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> p40 = - 9./24.; <span class="comment">//predictor coefficients</span>
<a name="l00303"></a>00303     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> p41 =  37./24.;
<a name="l00304"></a>00304     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> p42 = -59./24.;
<a name="l00305"></a>00305     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> p43 =  55./24.;
<a name="l00306"></a>00306     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> c40 =   1./24.; <span class="comment">//corrector coefficients</span>
<a name="l00307"></a>00307     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> c41 =  -5./24.;
<a name="l00308"></a>00308     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> c42 =  19./24.;
<a name="l00309"></a>00309     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> c43 =   9./24.;
<a name="l00310"></a>00310     <span class="keywordtype">int</span> i;
<a name="l00311"></a>00311     <span class="keywordtype">int</span> n,N = int(fabs((xend-x)/dx));
<a name="l00312"></a>00312     N = N&lt;5?5:N;
<a name="l00313"></a>00313     dx = (xend-x)/N;
<a name="l00314"></a>00314     <span class="keywordtype">double</span> *fp0 = f0;
<a name="l00315"></a>00315     <span class="keywordtype">double</span> *fp1 = f1;
<a name="l00316"></a>00316     <span class="keywordtype">double</span> *fp2 = f2;
<a name="l00317"></a>00317     <span class="keywordtype">double</span> *fp3 = f3;
<a name="l00318"></a>00318     RHS(x,dx, y,fp0);
<a name="l00319"></a>00319     RKutt1step(x,dx);  <span class="comment">//RKutt(x,x+dx,dx/4); x+=dx;</span>
<a name="l00320"></a>00320     RHS(x,dx, y,fp1);
<a name="l00321"></a>00321     RKutt1step(x,dx);  <span class="comment">//RKutt(x,x+dx,dx/4); x+=dx;</span>
<a name="l00322"></a>00322     RHS(x,dx, y,fp2);
<a name="l00323"></a>00323     RKutt1step(x,dx);  <span class="comment">//RKutt(x,x+dx,dx/4); x+=dx;</span>
<a name="l00324"></a>00324     <span class="keywordflow">for</span>(n=4; n&lt;=N; n++) {
<a name="l00325"></a>00325   <span class="comment">// next 2 lines is the Adams-Bashforth predictor</span>
<a name="l00326"></a>00326       RHS(x,dx, y,fp3);
<a name="l00327"></a>00327       <span class="keywordflow">for</span>(i=0; i&lt;nODE; i++) y1[i] = y[i]+(p43*fp3[i]+p42*fp2[i]+p41*fp1[i]+p40*fp0[i]);
<a name="l00328"></a>00328       x += dx;
<a name="l00329"></a>00329   <span class="comment">// next 2 lines is the Adams-Moulton corrector</span>
<a name="l00330"></a>00330       RHS(x,dx, y1,fp0);
<a name="l00331"></a>00331       <span class="keywordflow">for</span>(i=0; i&lt;nODE; i++) y[i]+=(c43*fp0[i]+c42*fp3[i]+c41*fp2[i]+c40*fp1[i]);
<a name="l00332"></a>00332       <span class="keywordtype">double</span> *fpw = fp0;
<a name="l00333"></a>00333       fp0 = fp1;
<a name="l00334"></a>00334       fp1 = fp2;
<a name="l00335"></a>00335       fp2 = fp3;
<a name="l00336"></a>00336       fp3 = fpw;
<a name="l00337"></a>00337     }
<a name="l00338"></a>00338   }
<a name="l00339"></a>00339 
<a name="l00340"></a>00340   <span class="comment">//***************************************************************************</span>
<a name="l00341"></a>00341   <span class="comment">// input: y[] at x; dx is the step</span>
<a name="l00342"></a>00342   <span class="comment">// output y[] at xend</span>
<a name="l00343"></a>00343   <span class="comment">// note: don't use this method, it has bad accuracy</span>
<a name="l00344"></a>00344   <span class="keywordtype">void</span> Adams3(<span class="keywordtype">double</span> x, <span class="keywordtype">double</span> xend,<span class="keywordtype">double</span> dx)
<a name="l00345"></a>00345   {
<a name="l00346"></a>00346     <span class="keywordtype">int</span> i;
<a name="l00347"></a>00347     <span class="keywordtype">int</span> n,N = int(fabs((xend-x)/dx));
<a name="l00348"></a>00348     N = N&lt;5?5:N;
<a name="l00349"></a>00349     dx = (xend-x)/N;
<a name="l00350"></a>00350     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> c0 =   5./12.;
<a name="l00351"></a>00351     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> c1 = -16./12.;
<a name="l00352"></a>00352     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> c2 =  23./12.;
<a name="l00353"></a>00353 
<a name="l00354"></a>00354     <span class="keywordtype">double</span> *fp0 = f0;
<a name="l00355"></a>00355     <span class="keywordtype">double</span> *fp1 = f1;
<a name="l00356"></a>00356     <span class="keywordtype">double</span> *fp2 = f2;
<a name="l00357"></a>00357     RHS(x,dx, y,fp0);
<a name="l00358"></a>00358     RKutt1step(x,dx);
<a name="l00359"></a>00359     RHS(x,dx, y,fp1);
<a name="l00360"></a>00360     RKutt1step(x,dx);
<a name="l00361"></a>00361     <span class="keywordflow">for</span>(n=3; n&lt;=N; n++) {
<a name="l00362"></a>00362       RHS(x,dx, y,fp2);
<a name="l00363"></a>00363       <span class="keywordflow">for</span>(i=0; i&lt;nODE; i++) y[i]+=(c2*fp2[i]+c1*fp1[i]+c0*fp0[i]);
<a name="l00364"></a>00364       <span class="keywordtype">double</span> *fpw = fp0;
<a name="l00365"></a>00365       fp0 = fp1;
<a name="l00366"></a>00366       fp1 = fp2;
<a name="l00367"></a>00367       fp2 = fpw;
<a name="l00368"></a>00368       x += dx;
<a name="l00369"></a>00369     }
<a name="l00370"></a>00370   }
<a name="l00371"></a>00371 <span class="preprocessor">#endif</span>
<a name="l00372"></a>00372 <span class="preprocessor"></span>};
<a name="l00373"></a>00373 
<a name="l00374"></a>00374 
<a name="l00375"></a>00375 };   <span class="comment">//namespace MConf</span>
<a name="l00376"></a>00376 
<a name="l00377"></a>00377 <span class="preprocessor">#endif</span>
</pre></div></div>
    <p><a class="anchor" name="BottomOfPage"></a></p>
    <div class="no-print" align="right">
      <table border="0">
        <tr>
        <td>[ <a class="el" href="#TopOfPage">top</a> ]</td>
        <td>[ <a class="el" href="javascript:history.back(-1);"><b>back</b></a> ]</td> 
        </tr>
      </table>
    </div>
    <hr class="separator">
    <div class="ippAddress" align="right">
      <table border="0">
        <tr>
          <td class="ippAddress">13 Oct 2021 &nbsp;&nbsp;&nbsp;&nbsp;</td>
          <td class="ippAddress">
            <a href="http://www.ipp.mpg.de"><img src="IPP.png" alt="www.ipp.mpg.de" border="0"></a>
          </td>
          <td class="ippAddress">
            <!-- Copyright &copy; 2005-2008<br> --> 
            Max-Planck-Institut<br>f&uuml;r Plasmaphysik
          </td>
        </tr>
      </table>
    </div>
  </div>
</div>
</body>
</html>
