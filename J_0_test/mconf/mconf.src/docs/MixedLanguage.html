<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <title>MConf: Mixed-language programming</title>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <meta name="author" content="Yuriy Turkin">
  <meta name="keywords" content="stellarator, w7x, W7-X, W7-X software">
  <meta name="description" content="W7-X Software">
  <link href="myCss.css" rel="stylesheet" type="text/css">
  <link href="tabs.css" rel="stylesheet" type="text/css" >
</head>
<body>
  <div class="centerAll" id="TopOfPage">
    <div class="bodyForAll">
<!-- Generated by Doxygen 1.5.8 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1><a class="anchor" name="MixedLanguage">Mixed-language programming </a></h1><dl class="user" compact><dt><b></b></dt><dd></dd></dl>
<ul>
<li><a class="el" href="MixedLanguage.html#FortranCallsC">Fortran calls C++</a></li><li><a class="el" href="MixedLanguage.html#CCallsFortran77">C++ calls Fortran 77</a></li><li><a class="el" href="MixedLanguage.html#CCallsFortran90">C++ calls Fortran 90</a></li><li><a class="el" href="MixedLanguage.html#Alignment">Struct Member Alignment</a></li></ul>
<p>
The interface described below removes decoration of names and therefore simplifies mixed-language programming. A decorated name is an internal representation of a procedure name or variable name that contains information about where it is declared; for procedures, the information includes how it is called.<p>
Some examples. The name of the Fortran routine <code>LOADVMEC</code> with declaration <div class="fragment"><pre class="fragment"> SUBROUTINE LOADVMEC(fname)
</pre></div> in an object file becomes <div class="fragment"><pre class="fragment"> loadvmec__ 
</pre></div><p>
The name of C++ method <code>loadvmec</code> with declaration <div class="fragment"><pre class="fragment"> <span class="keywordtype">bool</span> CStconfig::loadvmec(<span class="keyword">const</span> <span class="keywordtype">char</span> * fname) 
</pre></div> in an object file becomes <div class="fragment"><pre class="fragment"> _ZN9CStconfig8loadvmecEPKc 
</pre></div><p>
Fortran can not call directly C++ methods also because of Fortran knows nothing about C++ objects and the C++ object which the method belongs to must be created first.<h2><a class="anchor" name="FortranCallsC">
Fortran calls C++</a></h2>
This is an example of how to write interface C-function in order to call C++ function from within Fortran programs.<p>
Suppose we have C++ class <code>Box</code> declared in the header file <code>#include</code> <code>"Box.h"</code> <p>
<div class="fragment"><pre class="fragment"><span class="keyword">class </span>Box {
<span class="keyword">public</span>:
  <span class="comment">// Default constructor</span>
  Box() { lb=bb=hb=0; }
  <span class="comment">// Constructor </span>
  Box(<span class="keywordtype">double</span> length, <span class="keywordtype">double</span> breadth, <span class="keywordtype">double</span> height) {
    <span class="keyword">set</span>(length, breadth, height);
  }
  <span class="comment">// Function to set dimensions of a box</span>
  <span class="keywordtype">void</span> <span class="keyword">set</span>(<span class="keywordtype">double</span> length, <span class="keywordtype">double</span> breadth, <span class="keywordtype">double</span> height) {
     lb = length;  <span class="comment">// Set values of data members</span>
     bb = breadth; 
     hb = height;
  }
  <span class="comment">// Function to calculate the volume of a box</span>
  <span class="keywordtype">double</span> getVolume() {
     <span class="keywordflow">return</span> lb*bb*hb;
  }
<span class="keyword">private</span>:
  <span class="keywordtype">double</span> lb; <span class="comment">// Length of a box in inches</span>
  <span class="keywordtype">double</span> bb; <span class="comment">// Breadth of a box in inches</span>
  <span class="keywordtype">double</span> hb; <span class="comment">// Height of a box in inches</span>
};
</pre></div><p>
and we want to call <code>Box::getVolume()</code>. The solution is to write C wrappers (a C-function that provides an interface to C++ function or object) as it follows<p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include "Box.h"</span>

<span class="comment">// the following preprocessor directives take care about</span>
<span class="comment">// different naming conventions in Windows and *nix world</span>
<span class="preprocessor">#if (defined( __unix__ ) || (defined(linux)) )</span>
<span class="preprocessor"></span><span class="preprocessor">  #define __stdcall</span>
<span class="preprocessor"></span><span class="preprocessor">  #define BOX_LOAD    box_load_</span>
<span class="preprocessor"></span><span class="preprocessor">  #define BOX_VOLUME  box_volume_</span>
<span class="preprocessor"></span><span class="preprocessor">  #define BOX_FREE    box_free_</span>
<span class="preprocessor"></span><span class="preprocessor">#elif defined( _WIN32 )</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

<span class="comment">// Create and initialize an object Box. </span>
<span class="comment">// The first call must be made with *box==0, </span>
<span class="comment">// the following calls will reload data into the same object</span>
<span class="keyword">extern</span> <span class="stringliteral">"C"</span> <span class="keywordtype">void</span> __stdcall BOX_LOAD(Box **box,<span class="keywordtype">double</span> *l,<span class="keywordtype">double</span> *b,<span class="keywordtype">double</span> *h)
{
  Box *bx;
  <span class="keywordflow">if</span>(*box==0) bx = <span class="keyword">new</span> Box;   <span class="comment">// create object Box, </span>
  bx-&gt;set(*l, *b, *h);        <span class="comment">//  initialize it</span>
  *box = bx;                  <span class="comment">//   and return to caller its address</span>
}

<span class="comment">// Function to get the volume of a box</span>
<span class="keyword">extern</span> <span class="stringliteral">"C"</span> <span class="keywordtype">double</span> __stdcall BOX_VOLUME(Box **box)
{
  Box &amp;bx = **box;       <span class="comment">// set reference to box</span>
  <span class="keywordflow">return</span> bx.getVolume(); <span class="comment">// call object's method</span>
}

<span class="comment">// 'destructor' for Fortran</span>
<span class="keyword">extern</span> <span class="stringliteral">"C"</span> <span class="keywordtype">void</span> __stdcall BOX_FREE(Box **box)
{
  <span class="keywordflow">if</span> (*box) <span class="keyword">delete</span> (*box);
  *box=0;
}
</pre></div><p>
Finally the Fortran routine is<p>
<div class="fragment"><pre class="fragment">  implicit none
  real(8) BOX_VOLUME, volume
  real(8) length/20./, breadth/10./, height/10./
  integer(8) toyBox/0/  ! this variable holds the address of C++ <span class="keywordtype">object</span>
  external BOX_LOAD, BOX_VOLUME, BOX_FREE

! create  toyBox <span class="keywordtype">object</span> of type Box and initialize it
  call BOX_LOAD(toyBox,length, breadth, height)
  
! get the volume of the toyBox
  volume = BOX_VOLUME(toyBox)
  
! destroy toyBox <span class="keywordtype">object</span> and free memory
  call BOX_FREE(toyBox)       
  end
</pre></div><p>
<code>toyBox</code> is the pointer to the object of type Box; 8-byte is used in order to compile and run this program on a CPU with 64bit architecture without modifications.<p>
The interfacing described above is employed in <a class="el" href="cpp2for_8cpp.html">cpp2for.cpp</a><p>
<div class="no-print" align="right"><table border="0" cellspacing="3" cellpadding="3">
<tr>
<td>[ <a href="#TopOfPage" class="el">top</a> ] </td><td>[ <a href="#BottomOfPage" class="el">bottom</a> ] </td><td>[ <a href="javascript:history.back(-1);" class="el"><b>back</b></a> ]  </td></tr>
</table>
</div><div class="no-print"><hr>
</div><h2><a class="anchor" name="CCallsFortran77">
C++ calls Fortran 77</a></h2>
This is an example of how to call Fortran subroutine from within C++ programs.<p>
Suppose we have the Fortran 77 subroutine<p>
<div class="fragment"><pre class="fragment">      subroutine box_vol_f77(al,ab,ah,volume,arr,n)
</pre></div><p>
that we need to call from C++. The code below does this<p>
<div class="fragment"><pre class="fragment"><span class="comment">//**************************************************************</span>
<span class="preprocessor">#if (defined( __unix__ ) || (defined(linux)) )</span>
<span class="preprocessor"></span><span class="preprocessor">  #define SUBROUTINE        extern "C" void </span>
<span class="preprocessor"></span><span class="preprocessor">  #define REAL8_FUNCTION    extern "C" double </span>
<span class="preprocessor"></span><span class="preprocessor">  #define INT_FUNCTION      extern "C" int </span>
<span class="preprocessor"></span>  
<span class="preprocessor">  #define BOX_VOL_f77  box_vol_f77_</span>
<span class="preprocessor"></span><span class="preprocessor">#elif defined( _WIN32 )</span>
<span class="preprocessor"></span><span class="preprocessor">  #define SUBROUTINE        extern "C" void   __stdcall</span>
<span class="preprocessor"></span><span class="preprocessor">  #define REAL8_FUNCTION    extern "C" double __stdcall</span>
<span class="preprocessor"></span><span class="preprocessor">  #define INT_FUNCTION      extern "C" int    __stdcall</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define REAL8 double</span>
<span class="preprocessor"></span><span class="preprocessor">#define CALL    ;    // to mimic FORTRAN CALL</span>
<span class="preprocessor"></span>
<span class="comment">// prototype of Fortran routine</span>
SUBROUTINE BOX_VOL_f77(
       <span class="keyword">const</span>  REAL8 &amp;l,       <span class="comment">//[input]  scalar, [cm]</span>
       <span class="keyword">const</span>  REAL8 &amp;b,       <span class="comment">//[input]  scalar, [cm]</span>
       <span class="keyword">const</span>  REAL8 &amp;h,       <span class="comment">//[input]  scalar, [cm]</span>
       <span class="keyword">const</span>  REAL8 &amp;volume   <span class="comment">//[out] scalar, volume on output[cm^3]</span>
       <span class="keyword">const</span>  REAL8 *array,   <span class="comment">// array(narr), not used, example only</span>
       <span class="keyword">const</span>  <span class="keywordtype">int</span>   &amp;narr,    <span class="comment">// scalar, size of array</span>
       );

<span class="comment">// C function, that calls Fortran 77</span>
<span class="keywordtype">double</span> volume(<span class="keywordtype">double</span> l,<span class="keywordtype">double</span> b,<span class="keywordtype">double</span> h)
{ 
  <span class="keywordtype">int</span> n = 20;
  <span class="keywordtype">double</span> arr[n], volume;      
  CALL BOX_VOL_f77(l,b,h,volume,arr,n);
  <span class="keywordflow">return</span> volume;
}
</pre></div><p>
<div class="no-print" align="right"><table border="0" cellspacing="3" cellpadding="3">
<tr>
<td>[ <a href="#TopOfPage" class="el">top</a> ] </td><td>[ <a href="#BottomOfPage" class="el">bottom</a> ] </td><td>[ <a href="javascript:history.back(-1);" class="el"><b>back</b></a> ]  </td></tr>
</table>
</div><div class="no-print"><hr>
</div><h2><a class="anchor" name="CCallsFortran90">
C++ calls Fortran 90</a></h2>
Suppose we have the Fortran 90 module with subroutines <code>box_set</code> , <code>box_volume</code> <p>
<div class="fragment"><pre class="fragment">  MODULE BOX_mod
    IMPLICIT NONE
    REAL(8), PRIVATE :: al,ab,ah
    CONTAINS
    
    SUBROUTINE box_set(l,b,h)
      REAL(8) l,b,h
      al = l
      ab = b
      ah = h
    END SUBROUTINE box_set
    
    SUBROUTINE box_volume(volume)
      REAL(8) volume
      volume = al*ab*ah
    END SUBROUTINE box_volume
    
   END MODULE BOX_mod
</pre></div><p>
At first we need Fortran 77 interface to remove decoration of names<p>
<div class="fragment"><pre class="fragment">SUBROUTINE BOX_VOL_f77(al,ab,ah,volume)
  USE BOX_mod, ONLY : box_set,box_volume
  implicit none
  real(8) l,ab,ah,volume
  call box_set(al,ab,ah)
  call box_volume(volume)
END SUBROUTINE BOX_f77
</pre></div><p>
then see section <a class="el" href="MixedLanguage.html#CCallsFortran77">C++ calls Fortran 77</a><h2><a class="anchor" name="Alignment">
Struct Member Alignment</a></h2>
If you pass structures across the languages then the use of Alignment option is important <div class="fragment"><pre class="fragment">/Zp8  ---  Visual C, Intel C and Fortran ,  Intel/Digital/Compaq Fortran
</pre></div><p>
The Struct Member Alignment (/Zpn) option controls how the members of a structure are packed into memory and specifies the same packing for all structures in a module. When you specify this option, each structure member after the first is stored on either the size of the member type or n-byte boundaries (where n is 1, 2, 4, 8, or 16), whichever is smaller. </div>
    <p><a class="anchor" name="BottomOfPage"></a></p>
    <div class="no-print" align="right">
      <table border="0">
        <tr>
        <td>[ <a class="el" href="#TopOfPage">top</a> ]</td>
        <td>[ <a class="el" href="javascript:history.back(-1);"><b>back</b></a> ]</td> 
        </tr>
      </table>
    </div>
    <hr class="separator">
    <div class="ippAddress" align="right">
      <table border="0">
        <tr>
          <td class="ippAddress">13 Oct 2021 &nbsp;&nbsp;&nbsp;&nbsp;</td>
          <td class="ippAddress">
            <a href="http://www.ipp.mpg.de"><img src="IPP.png" alt="www.ipp.mpg.de" border="0"></a>
          </td>
          <td class="ippAddress">
            <!-- Copyright &copy; 2005-2008<br> --> 
            Max-Planck-Institut<br>f&uuml;r Plasmaphysik
          </td>
        </tr>
      </table>
    </div>
  </div>
</div>
</body>
</html>
